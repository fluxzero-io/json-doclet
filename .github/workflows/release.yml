name: Build and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.prepare.outputs.release_version }}
      new_tag: ${{ steps.prepare.outputs.new_tag }}
      changelog: ${{ steps.prepare.outputs.changelog }}
      skipped: ${{ steps.prepare.outputs.skipped }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version (dry run)
        id: bump
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dry_run: true
          default_bump: patch
          custom_release_rules: '[{"type":"feat","release":"minor"}]'
          release_branches: main

      - name: Prepare version outputs
        id: prepare
        env:
          NEW_TAG: ${{ steps.bump.outputs.new_tag }}
          PREVIOUS_TAG: ${{ steps.bump.outputs.tag }}
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          CHANGELOG: ${{ steps.bump.outputs.changelog }}
        run: |
          set -eo pipefail
          new_tag="$NEW_TAG"
          if [ -z "$new_tag" ]; then
            new_tag="v$NEW_VERSION"
          fi
          release_version="$NEW_VERSION"
          if [ -z "$release_version" ]; then
            echo "No new version detected" >&2
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$new_tag" = "$PREVIOUS_TAG" ]; then
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            echo "release_version=$release_version" >> "$GITHUB_OUTPUT"
            echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
            echo "changelog=" >> "$GITHUB_OUTPUT"
          else
            echo "skipped=false" >> "$GITHUB_OUTPUT"
            echo "release_version=$release_version" >> "$GITHUB_OUTPUT"
            echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
            printf 'changelog<<EOF\n%s\nEOF\n' "$CHANGELOG" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: determine-version
    if: needs.determine-version.outputs.skipped != 'true'
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: ${{ needs.determine-version.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.OSSRH_SIGNING_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Set maven version
        run: |
          ./mvnw -B versions:set -DnewVersion=${{ env.RELEASE_VERSION }}

      - name: Build and deploy to Maven Central
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.OSSRH_SIGNING_PASSPHRASE }}
        run: ./mvnw -B -P sign clean deploy

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          name: v${{ env.RELEASE_VERSION }}
          body: ${{ needs.determine-version.outputs.changelog }}
          files: |
            target/json-doclet-${{ env.RELEASE_VERSION }}.jar
            src/main/resources/json-doclet.schema.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
